<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script type="text/javascript" src="/static/js/head.js"></script>
<link rel="stylesheet" type="text/css" href="/static/css/contractList.css" />
</head> 
<body id="layout" class="easyui-layout">
	<div data-options="region:'center',border:false">
		<table id="infoDrid"></table>
	</div>
	<input type="hidden" id="contractId">
<!-- 查询条件 -->
<div data-options="region:'east',split:true,title:'信息查询',border:false" style="width:250px;padding:5px;">
<form id="searchForm">
	<table class="searchTable">
		<tr>
			<td class="searchLeft">合同名称：</td>
			<td class="searchRight">
				<input class="easyui-validatebox" name="username" id="usernameSearch">
			</td>
		</tr>
		<tr>
			<td  class="searchLeft">合同编号：</td>
			<td class="searchRight">
				<input class="easyui-validatebox" name="loginname" id="loginnameSearch" value=''>
				<input id="signdate" type="hidden" value="">
			</td>
		</tr>
		<tr>
			<td class="searchLeft">开始时间：</td>
			<td class="searchRight">
				<input class="easyui-datetimebox" name="stattime" id="stattimeSearch">
			</td>
		</tr>
		<tr>
			<td  class="searchLeft">结束时间：</td>
			<td class="searchRight">
				<input class="easyui-datetimebox" name="endtime" id="endtimeSearch">
			</td>
		</tr>
	</table>
	<div>
	<a id="searchbtn" class="easyui-linkbutton" data-options="iconCls:'icon-ccSearch'" style="margin-left:50px">查询</a>
	<a id="resetbtn"   class="easyui-linkbutton" data-options="iconCls:'icon-ccReload'">重置</a>
	</div>
</form>
</div>
	<!-- dataGrid工具栏 -->
	<div id="toolbar">
		<a id="updateFinance" href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-ccEdit',plain:true" >更新财务信息</a>
		<a id="createContractOrder" href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-ccAdd',plain:true" >创建订单</a>
		<a id="edit" href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-ccEdit',plain:true" >编辑订单</a>
		<a id="finish" href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-lock',plain:true" >结束订单</a>
		<a id="delete" href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-cancel',plain:true" >删除订单</a>
		<!-- <a id="search" href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-ccSearch',plain:true" >查询</a> -->
	</div>
	<!-- 添加合同订单 -->
	<div id="addDialog">
		<form id="addForm">
			<table class="tableForm">
				<tr>
					<td class="formLeft">订单编号:</td>
					<td>
						<input class="easyui-validatebox" data-options="validType:'positionCodes',required:true" name="orderNo" id="orderNo">
					</td>
				</tr>
				<tr>
					<td class="formLeft">订单名称:</td>
					<td>
						<input class="easyui-validatebox" data-options="validType:'positionCodes',required:true" name="orderName" id="orderName">
					</td>
				</tr>
				<tr>
					<td class="formLeft">大项编号:</td>
					<td>
						<input class="easyui-validatebox"  data-options="required:true" name="bigItemNo" id="bigItemNo">
					</td>
				</tr>
				<tr>
					<td class="formLeft">订单金额:</td>
					<td>
						<input class="easyui-validatebox"  data-options="required:true" name="orderAmount" id="orderAmount">
					</td>
				</tr>
				<tr>
					<td class="formLeft">开始时间:</td>
					<td>
						<input class="easyui-datebox"  data-options="required:true" name="startTime" id="startTime">
					</td>
				</tr>
			</table>
		</form>
	</div>
	<div id="updateDialog">
		<form id="updateForm">
			<table class="tableForm">
				<tr>
					<td class="formLeft">MISS编号:</td>
					<td>
						<input class="easyui-validatebox" data-options="validType:'positionCodes',required:true" name="missNo" id="missNo">
						<input id="orderId" value="0" type="hidden">
					</td>
				</tr>
				<tr>
					<td class="formLeft">开票金额:</td>
					<td>
						<input class="easyui-validatebox" data-options="validType:'positionCodes',required:true" name="invoiceAmount" id="invoiceAmount">
					</td>
				</tr>
				<tr>
					<td class="formLeft">税率:</td>
					<td id="updateRoleTD">
					<input class="easyui-validatebox" data-options="validType:'positionCodes',required:true" name="taxRate" id="taxRate">
					</td>
				</tr>
				<tr id="stateRow" >
					<td class="formLeft">回款金额:</td>
					<td>
						<input class="easyui-validatebox" data-options="validType:'positionCodes',required:true" name="amountCashed" id="amountCashed">
					</td>
				</tr>
			</table>
		</form>
	</div>
	<div id="editDialog">
		<form id="editForm">
			<table class="tableForm">
				<tr>
					<td class="formLeft">订单编号:</td>
					<td>
						<input class="easyui-validatebox" data-options="required:true" name="orderNo" id="orderNo">
						<input id="orderID" value="0" type="hidden">
					</td>
				</tr>
				<tr>
					<td class="formLeft">订单名称:</td>
					<td>
						<input class="easyui-validatebox" data-options="required:true" name="orderName" id="orderName">
					</td>
				</tr>
				<tr>
					<td class="formLeft">大项编号:</td>
					<td id="updateRoleTD">
					<input class="easyui-validatebox" data-options="required:true" name="bigItemNo" id="bigItemNo">
					</td>
				</tr>
				<tr id="stateRow" >
					<td class="formLeft">订单金额:</td>
					<td>
						<input class="easyui-validatebox" data-options="required:true" name="orderAmount" id="orderAmount">
					</td>
				</tr>
				<tr id="stateRow" >
					<td class="formLeft">开始时间:</td>
					<td>
						<input class="easyui-datebox" data-options="required:true" name="startTime" id="startTime">
					</td>
				</tr>
			</table>
		</form>
	</div>
</body>
</html>

<script>
	$(function(){
		$.ajaxSetup({crossDomain: true, xhrFields: {withCredentials: true}});
		$("#contractId").val(sessionStorage.getItem('contractId'));
		sessionStorage.setItem("contractId","");
		sessionStorage.setItem("contractName","");
		//页面初始化
		layoutLoad();
		//数据表格加载
		gridLoad(1,20);	
		//loadAndSetGridData();	
		//点击事件
		clickFunction();
	});
	//页面初始化
	function layoutLoad(){
		$('#layout').layout('collapse','east');
		//信息添加dialog
		$('#addDialog').dialog({
			title: '添加合同订单',
		    width: 300,
		    height:300,
		    closed: true,    
		    modal: true,
		    buttons:[{
				text:'确定',
				iconCls:'icon-ok',
				handler:function(){
					addInfo();//添加信息
                }
			},{
				text:'取消',
				iconCls:'icon-cancel',
				handler:function(){
					$('#addDialog').dialog('close');
				}
			}], 
		});
		$('#updateDialog').dialog({
			title: '更新财务信息',
		    width: 300,
		    height:400,
		    closed: true,
		    modal: true,
		    buttons:[{
				text:'确定',
				iconCls:'icon-ok',
				handler:function(){
					updatedInfo();//添加信息
                }
			},{
				text:'取消',
				iconCls:'icon-cancel',
				handler:function(){
					$('#updateDialog').dialog('close');
				}
			}], 
		});
		$('#editDialog').dialog({
			title: '编辑订单',
		    width: 300,
		    height:400,
		    closed: true,
		    modal: true,
		    buttons:[{
				text:'确定',
				iconCls:'icon-ok',
				handler:function(){
					editInfo();//添加信息
                }
			},{
				text:'取消',
				iconCls:'icon-cancel',
				handler:function(){
					$('#editDialog').dialog('close');
				}
			}], 
		});
	}
	//数据表格加载
	function gridLoad(pageNumber,pageSize) {
		$.ajax({
			url : getHost() + '/contract_order/list/pageable/adapter/order_by_create_time_desc',
			type : "GET",
			data : {
				"pageNumber": pageNumber,
			    "pageSize": pageSize,
			    "contractId" : $("#contractId").val()
			},
			async : false,
			dataType : "json",
			contentType: 'application/json;charset=UTF-8',
			success : function(data) {
				if (data.code==200&&typeof(data.data) == "object") {
					var width = $('#infoDrid').parent().width();
					var height = $('#infoDrid').parent().height();
					$('#infoDrid').datagrid({
						toolbar : "#toolbar",
						data: data.data.page.rows,
						width : width,
						height : height,
						async : false,
						fit : true,
						border : false,
						singleSelect : true,
						fitColumns : true,
						striped : true,
						pagination : true,
						columns : [ [
							{field:'orderNo',title:'订单编号' ,align:'center',width:150},
							{field:'orderName',title:'订单名称',align:'center',width:150},
							{field:'bigItemNo',title:'大项编号',align:'center',width:150},
							{field:'orderAmount',title:'订单金额',align:'center',width:150},
							{field:'startTime',title:'开始时间',align:'center',width:150},
							{field:'id',title:'操作',align:'center',width:100,
								formatter: function(value,row,index){
									return "<input style=\"cursor:pointer;\" type=\"button\" value=\"小项列表\" onClick=\"smallItemList(" + index + ")\" style=\"width:100px\"/>";
								}
							},
						] ],
					});
						var p = $('#infoDrid').datagrid('getPager');
				        $(p).pagination({
				        	total : data.data.page.total,
				            pageSize: pageSize,//每页显示的记录条数，默认为10
				            pageList: [20, 50, 100],//可以设置每页记录条数的列表
				            pageNumber : pageNumber,
				            beforePageText: '第',//页数文本框前显示的汉字
				            afterPageText: '页    共 {pages} 页',
				            displayMsg: '当前显示 {from}-{to} 条记录,共 {total} 条记录',
				            showRefresh : false,
				            onSelectPage:function(pageNumber, pageSize){
				        		gridLoad(pageNumber,pageSize);
				        	}
				        });
				}
			}
		});
	}
	//点击事件
	function clickFunction() {
		$('#search').click(function() {
			$('#layout').layout('expand', 'east');
		});
		//点击查询
		$('#searchbtn').click(function() {
			gridLoad(1,20);
		});
		$('#resetbtn').click(function() {
			$('#searchForm')[0].reset();
			$("#loginnameSearch").val('');
			$("#signdate").val('');
			$('#stattimeSearch').datetimebox('setValue', '');
			$('#endtimeSearch').datetimebox('setValue', '');
			gridLoad(1,20);
		});
		$('#createContractOrder').click(function(){
			$('#addForm')[0].reset();
			$('#addDialog').dialog('open');
		});
		//订单详情
		$('#updateFinance').click(function() {
			var row = $('#infoDrid').datagrid('getSelected');
			if(row==null){
				$.messager.alert("提示","请选中一行!");
				return;
			}
			$('#updateForm')[0].reset();
			$("#orderId").val(row.id);
			$('#updateDialog').dialog('open');
		});
		
		//编辑点击事件
		$('#edit').click(function() {
			var row = $('#infoDrid').datagrid('getSelected');
			if(row==null){
				$.messager.alert("提示","请选中一行!");
				return;
			}
			$('#editForm')[0].reset();
			$("#orderID").val(row.id);
			$('#editForm').form('load',row);
			$('#editDialog').dialog('open');
		});
		//删除 
		$('#delete').click(function() {
			var row = $('#infoDrid').datagrid('getSelected');
			if(row==null){
				$.messager.alert("提示","请选中一行!");
				return;
			}
			$.messager.confirm('提示','确定要删除吗?',function(r){
			    if (r){
			    	$.ajax({
						url:getHost() + '/contract_order/' + row.id,
						type:'DELETE',
						error:function(){
							$.messager.alert("提示","数据操作存在异常!");
						},
						contentType: 'application/json;charset=UTF-8',
						success:function(data){
							if(data.code=200){
								$.messager.alert("提示","删除成功");
								gridLoad(1,20);
							}else{
								$.messager.alert("提示",data.message);
							}
						}
					});
			    }
			});
		});
		//结束订单
		$('#finish').click(function() {
			var row = $('#infoDrid').datagrid('getSelected');
			if(row==null){
				$.messager.alert("提示","请选中一行!");
				return;
			}
			$.messager.confirm('提示','确定要结束吗?',function(r){
			    if (r){
			    	$.ajax({
						url:getHost() + '/contract_order/end?contractOrderId=' + row.id,
						type:'GET',
						error:function(){
							$.messager.alert("提示","数据操作存在异常!");
						},
						contentType: 'application/json;charset=UTF-8',
						success:function(data){
							if(data.code=200){
								$.messager.alert("提示","结束订单成功");
								gridLoad(1,20);
							}else{
								$.messager.alert("提示",data.message);
							}
						}
					});
			    }
			});
		});
	}
	//添加信息
	function addInfo(){
		if($("#orderNo").val()==null ||$("#orderNo").val()==""){
			$.messager.alert("提示","订单编号不能为空!");
			return;
		}
		if($("#orderName").val()==null ||$("#nickname").val()==""){
			$.messager.alert("提示","订单名称不能为空!");
			return;
		}
		if($("#bigItemNo").val()==null ||$("#bigItemNo").val()==""){
			$.messager.alert("提示","大项编号不能为空!");
			return;
		}
		if($("#orderAmount").val()==null ||$("#orderAmount").val()==""){
			$.messager.alert("提示","订单金额不能为空!");
			return;
		}
		$.ajax({
			url:getHost() + '/contract_order',
			type:'POST',
			data:JSON.stringify({
				orderNo : $("#orderNo").val(),
				orderName : $("#orderName").val(),
				bigItemNo : $("#bigItemNo").val(),
				orderAmount : $("#orderAmount").val(),
				contractId : $("#contractId").val(),
				startTime : $("#startTime").val(),
			}),
			contentType: 'application/json;charset=UTF-8',
			beforeSend: function(xhr) {
                xhr.withCredentials = true;
            },
            crossDomain:true,
			error:function(){
				$.messager.alert("提示","数据操作存在异常!");
				$('#addDialog').dialog('close');
			},
			success:function(data){
				if(data.code==200&&typeof(data.data) == "object"&&typeof(data.data.item) == "object"&&data.data.item.id>0){
					$.messager.alert("提示","创建成功");
					$('#addForm').form('clear');
					$('#addDialog').dialog('close');
					$('#infoDrid').datagrid('load');
					gridLoad(1,20);
				}else{
					$.messager.alert("提示",data.message);
				}
			}
		});
	}
	//更新财务信息 
	function updatedInfo(){
		if($("#missNo").val()==null ||$("#missNo").val()==""){
			$.messager.alert("提示","MISS编号不能为空!");
			return;
		}
		if($("#invoiceAmount").val()==null ||$("#invoiceAmount").val()==""){
			$.messager.alert("提示","开票金额不能为空!");
			return;
		}
		if($("#taxRate").val()==null ||$("#taxRate").val()==""){
			$.messager.alert("提示","税率不能为空!");
			return;
		}
		if($("#amountCashed").val()==null ||$("#amountCashed").val()==""){
			$.messager.alert("提示","回款金额不能为空!");
			return;
		}
		$.ajax({
			url:getHost() + '/contract_order/update_finance_item',
			type:'PUT',
			data:JSON.stringify({
				"id": $("#orderId").val(),
			    "missNo": $("#missNo").val(),
			    "invoiceAmount": $("#invoiceAmount").val(),
			    "taxRate": $("#taxRate").val(),
			    "amountCashed": $("#amountCashed").val(),
			}),
			contentType: 'application/json;charset=UTF-8',
			beforeSend: function(xhr) {
                xhr.withCredentials = true;
            },
            crossDomain:true,
			error:function(){
				$.messager.alert("提示","数据操作存在异常!");
				$('#addDialog').dialog('close');
			},
			success:function(data){
				if(data.code==200&&typeof(data.data) == "object"&&typeof(data.data.item) == "object"&&data.data.item.id>0){
					$.messager.alert("提示","修改成功");
					$('#updateForm').form('clear');
					$('#updateDialog').dialog('close');
					//$('#infoDrid').datagrid('load');
					gridLoad(1,20);
				}else{
					$.messager.alert("提示",data.message);
				}
			}
		});
	}
	//添加信息
	function editInfo(){
		if($("#editForm").form('validate')){
			$.ajax({
				url:getHost() + '/contract_order',
				type:'PUT',
				data:JSON.stringify({
					orderNo : $("#orderNo").val(),
					orderName : $("#orderName").val(),
					bigItemNo : $("#bigItemNo").val(),
					orderAmount : $("#orderAmount").val(),
					contractId : $("#contractId").val(),
					startTime : $("#startTime").val(),
					id : $("#orderID").val(),
				}),
				dataType : "json",
				contentType: 'application/json;charset=UTF-8',
				error : function(XMLHttpRequest, textStatus, errorThrown){
					$.messager.alert("提示","数据操作存在异常!");
				},
				beforeSend: function(xhr) {
	                xhr.withCredentials = true;
	            },
	            crossDomain:true,
				success:function(data){
					if(data.code=="200"&&data.data.item.id>0){
						$.messager.alert("提示","保存成功");
						$('#editForm').form('clear');
						$('#editDialog').dialog('close');
						gridLoad(1,20);
					}else{
						$.messager.alert("提示",data.message);
					}
				}
			});
		}
	}
	//查看合同订单列表 
	function smallItemList(index) {
		var rows = $('#infoDrid').datagrid('getRows');//获得所有行
        var row = rows[index];//根据index获得其中一行。
		sessionStorage.setItem('orderId',row.id);
		sessionStorage.setItem('orderName',row.orderName);
		parent.addTab('小项列表',  "/smallItemList.html");
	};
</script>